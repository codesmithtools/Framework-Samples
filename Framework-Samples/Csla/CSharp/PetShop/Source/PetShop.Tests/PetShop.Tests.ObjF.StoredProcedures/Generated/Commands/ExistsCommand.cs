//------------------------------------------------------------------------------
// <autogenerated>
//     This code was generated using CodeSmith: v6.5.0, CSLA Templates: v4.0.0.0, CSLA Framework: v4.3.10.
//     Changes to this file will be lost after each regeneration.
//
//     Template: ExistsCommand.cst
//     Template website: http://code.google.com/p/codesmith/
// </autogenerated>
//------------------------------------------------------------------------------
using System;

using System.Data.SqlClient;

using Csla;
using Csla.Data;

namespace PetShop.Tests.ObjF.StoredProcedures
{
    [Serializable]
    public class ExistsCommand : CommandBase<ExistsCommand>
    {
        #region Constructor(s)

        public ExistsCommand()
        {
        }

        #endregion

        #region Authorization Methods

        public static bool CanExecuteCommand()
        {
            return true;
        }

        #endregion

        #region Client-side Code

        private PetShop.Tests.ObjF.StoredProcedures.IGeneratedCriteria Criteria { get; set; }
        public bool Result { get; private set; }

        private void BeforeServer(PetShop.Tests.ObjF.StoredProcedures.IGeneratedCriteria criteria)
        {
            Criteria = criteria;
            Result = false;
        }

        private void AfterServer()
        {
        }

        #endregion

        #region Factory Methods 

        public static bool Execute<T>(T criteria) where T : PetShop.Tests.ObjF.StoredProcedures.IGeneratedCriteria
        {
            if (!CanExecuteCommand())
                throw new System.Security.SecurityException("Not authorized to execute command");

            var cmd = new ExistsCommand();
            cmd.BeforeServer(criteria);
            cmd = DataPortal.Execute(cmd);
            cmd.AfterServer();

            return cmd.Result;
        }

        public static void ExecuteAsync<T>(T criteria, EventHandler<DataPortalResult<ExistsCommand>> handler) where T : PetShop.Tests.ObjF.StoredProcedures.IGeneratedCriteria
        {
            if (!CanExecuteCommand())
                throw new System.Security.SecurityException("Not authorized to execute command");

            var cmd = new ExistsCommand();
            cmd.BeforeServer(criteria);

            var dp = new DataPortal<ExistsCommand>();
            dp.ExecuteCompleted += handler;
            dp.BeginExecute(cmd);
        }

        #endregion


        #region Data Access

        protected override void DataPortal_Execute()
        {
            string commandText = String.Format("SELECT COUNT(1) FROM {0} {1}", Criteria.TableFullName, ADOHelper.BuildWhereStatement(Criteria.StateBag));
            using (var connection = new SqlConnection(ADOHelper.ConnectionString))
            {
                connection.Open();
                using (var command = new SqlCommand(commandText, connection))
                {
                    command.Parameters.AddRange(ADOHelper.SqlParameters(Criteria.StateBag));
                    Result = (int)command.ExecuteScalar() > 0;
                }
            }
        }

        #endregion

    }
}