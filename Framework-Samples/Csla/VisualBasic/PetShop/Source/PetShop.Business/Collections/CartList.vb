'------------------------------------------------------------------------------
' <autogenerated>
'     This code was generated using CodeSmith: v5.2.2, CSLA Templates: v3.0.0.0, CSLA Framework: v3.8.4.
'       Changes to this template will not be lost.
'
'     Template: EditableChildList.cst
'     Template website: http://code.google.com/p/codesmith/
' </autogenerated>
'------------------------------------------------------------------------------
Option Explicit On
Option Strict On

Imports System
Imports System.Collections.Generic

Imports Csla

Namespace PetShop.Business
    Public Partial Class CartList
#Region "Authorization Rules"
    
        Private Sub AddAuthorizationRules()
            ''More information on these rules can be found here (http://www.devx.com/codemag/Article/40663/1763/page/2).
    
            'Dim canWrite As String() = { "AdminUser", "RegularUser" }
            'Dim canRead As String() = { "AdminUser", "RegularUser", "ReadOnlyUser" }
            'Dim admin As String() = { "AdminUser" }
    
            'AuthorizationRules.AllowCreate(GetType(CartList), admin)
            'AuthorizationRules.AllowDelete(GetType(CartList), admin)
            'AuthorizationRules.AllowEdit(GetType(CartList), canWrite)
            'AuthorizationRules.AllowGet(GetType(CartList), canRead)
    
            ''CartId
            'AuthorizationRules.AllowRead(_cartIdProperty, canRead)
    
            ''UniqueID
            'AuthorizationRules.AllowWrite(_uniqueIDProperty, canWrite)
            'AuthorizationRules.AllowRead(_uniqueIDProperty, canRead)
    
            ''ItemId
            'AuthorizationRules.AllowWrite(_itemIdProperty, canWrite)
            'AuthorizationRules.AllowRead(_itemIdProperty, canRead)
    
            ''Name
            'AuthorizationRules.AllowWrite(_nameProperty, canWrite)
            'AuthorizationRules.AllowRead(_nameProperty, canRead)
    
            ''Type
            'AuthorizationRules.AllowWrite(_typeProperty, canWrite)
            'AuthorizationRules.AllowRead(_typeProperty, canRead)
    
            ''Price
            'AuthorizationRules.AllowWrite(_priceProperty, canWrite)
            'AuthorizationRules.AllowRead(_priceProperty, canRead)
    
            ''CategoryId
            'AuthorizationRules.AllowWrite(_categoryIdProperty, canWrite)
            'AuthorizationRules.AllowRead(_categoryIdProperty, canRead)
    
            ''ProductId
            'AuthorizationRules.AllowWrite(_productIdProperty, canWrite)
            'AuthorizationRules.AllowRead(_productIdProperty, canRead)
    
            ''IsShoppingCart
            'AuthorizationRules.AllowWrite(_isShoppingCartProperty, canWrite)
            'AuthorizationRules.AllowRead(_isShoppingCartProperty, canRead)
    
            ''Quantity
            'AuthorizationRules.AllowWrite(_quantityProperty, canWrite)
            'AuthorizationRules.AllowRead(_quantityProperty, canRead)
    
            ''ProfileMember
            'AuthorizationRules.AllowRead(_profileMemberProperty, canRead)
    
    ' NOTE: Many-To-Many support coming soon.
        End Sub
    
#End Region

#Region "Custom Factory Methods"

    Friend Shared Function GetCart(ByVal uniqueID As Integer, ByVal isShoppingCart As Boolean) As CartList
        Dim criteria As New CartCriteria
        criteria.UniqueID = uniqueID
        criteria.IsShoppingCart = isShoppingCart

        Return DataPortal.FetchChild(Of CartList)(criteria)
    End Function

#End Region

#Region "Properties"

    ''' <summary>
    ''' Calculate the total for all the Items in the Cart.
    ''' </summary>
    Public ReadOnly Property Total() As Decimal
        Get
            Dim totalValue As Decimal = 0
            For Each cart As Cart In Me
                totalValue += cart.Price * cart.Quantity
            Next

            Return totalValue
        End Get
    End Property

#End Region

#Region "Methods"

    ''' <summary>
    ''' Update the quantity for item that exists in the cart.
    ''' </summary>
    ''' <param name="itemId">Item Id</param>
    ''' <param name="quantity">Quantity</param>
    Public Sub SetQuantity(ByVal itemId As String, ByVal quantity As Integer)
        Dim index As Integer = 0
        For Each cart As Cart In Me
            If cart.ItemId = itemId Then
                Exit For
            End If

            System.Math.Max(System.Threading.Interlocked.Increment(index), index - 1)
        Next

        Me(index).Quantity = quantity
    End Sub

    ''' <summary>
    ''' Add an item to the cart.
    ''' When ItemId to be added has already existed, this method will update the quantity instead.
    ''' </summary>
    ''' <param name="itemId">Item to add</param>
    ''' <param name="uniqueID">Cart's Unique ID</param>
    ''' <param name="isShoppingCart">Cart is a shopping cart.</param>
    Public Overloads Sub Add(ByVal itemId As String, ByVal uniqueID As Integer, ByVal isShoppingCart As Boolean)
        Add(itemId, uniqueID, isShoppingCart, 1)
    End Sub
    ''' <summary>
    ''' Add an item to the cart.
    ''' When ItemId to be added has already existed, this method will update the quantity instead.
    ''' </summary>
    ''' <param name="itemId">Item to add</param>
    ''' <param name="uniqueID">Cart's Unique ID</param>
    ''' <param name="isShoppingCart">Cart is a shopping cart.</param>
    ''' <param name="quantity">Item Quanitity</param>
    Public Overloads Sub Add(ByVal itemId As String, ByVal uniqueID As Integer, ByVal isShoppingCart As Boolean, ByVal quantity As Integer)
        Dim index As Integer = 0
        Dim found As Boolean = False

        For Each cart As Cart In Me
            If cart.ItemId = itemId Then
                found = True
                Exit For
            End If

            System.Math.Max(System.Threading.Interlocked.Increment(index), index - 1)
        Next

        If found Then
            Items(index).Quantity += quantity
        Else
            Dim item As Item = item.GetByItemId(itemId)
            Dim product As Product = product.GetByProductId(item.ProductId)
            Dim cart As Cart = cart.NewCart()
            cart.UniqueID = uniqueID
            cart.ItemId = itemId
            cart.Name = item.Name
            cart.ProductId = item.ProductId
            cart.IsShoppingCart = isShoppingCart
            cart.Price = If(item.ListPrice, If(item.UnitCost, 0))
            cart.Type = product.Name
            cart.CategoryId = product.CategoryId
            cart.Quantity = quantity

            Add(cart)
        End If
    End Sub

    ''' <summary>
    ''' Remove item from the cart based on itemId.
    ''' </summary>
    ''' <param name="itemId">ItemId of item to remove</param>
    Public Overloads Sub Remove(ByVal itemId As String)
        Dim index As Integer = 0
        For Each cart As Cart In Me
            If cart.ItemId = itemId Then
                Exit For
            End If

            System.Math.Max(System.Threading.Interlocked.Increment(index), index - 1)
        Next

        RemoveItem(index)
    End Sub

    ''' <summary>
    ''' Method to convert all cart items to order line items
    ''' </summary>
    Public Sub SaveOrderLineItems(ByVal orderId As Integer)
        Dim lineNum As Integer = 0

        For Each item As Cart In Me
            Dim lineItem As LineItem = lineItem.NewLineItem()
            lineItem.OrderId = orderId
            lineItem.ItemId = item.ItemId
            lineItem.LineNum = System.Threading.Interlocked.Increment(lineNum)
            lineItem.Quantity = item.Quantity
            lineItem.UnitPrice = item.Price

            lineItem = lineItem.Save()
        Next
    End Sub

#End Region

    End Class
End Namespace